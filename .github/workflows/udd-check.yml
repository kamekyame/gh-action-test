name: Deno deps checker

on:
  workflow_call:
    inputs:
      deps_file:
        required: false
        type: string
    secrets:
      APP_ID:
        required: true
      PRIVATE_KEY:
        required: true

jobs:
  udd-check:
    runs-on: ubuntu-latest
    steps:
        - name: Show inputs
          run: |
            echo deps file is ${{ inputs.deps_file }}
        - uses: actions/checkout@v2
        - name: Generate token
          id: generate_token
          uses: tibdex/github-app-token@v1
          with:
            app_id: ${{ secrets.APP_ID }}
            private_key: ${{ secrets.PRIVATE_KEY }}
        - name: Git config
          run: |
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
        - uses: denoland/setup-deno@v1
          with:
            deno-version: v1.x
        - name: Install udd
          run: |
            deno install -A -f -n udd https://deno.land/x/udd/main.ts
        - name: Check Update
          run: |
            udd ${{ inputs.deps_file }}
        - name: Git diff
          id: diff
          run: |
            git add ${{ inputs.deps_file }}
            if git diff --exit-code deps.ts ; then
              echo "::set-output name=changes_exist::true"
            else
              echo "::set-output name=changes_exist::false"
            fi
        - name: Git checkout
          if: steps.diff.outputs.changes_exist == 'true'
          run: | 
            git checkout -b actions/udd
        - name: Git commit
          if: steps.diff.outputs.changes_exist == 'true'
          run: |
            git commit -m "Update dependency"
            git push --set-upstream origin actions/udd
        - name: Create Pull Request
          if: steps.diff.outputs.changes_exist == 'true'
          run: gh pr create --title "Update Deno Dependency" --body ""
          env:
            GH_TOKEN: ${{ steps.generate_token.outputs.token }}